```python
import collections
import io
import tokenize
import itertools
import youtube_dl.compat as compat_tokenize_tokenize

def build_format_selector(self, format_spec):
    # ... (unchanged code) ...

    return final_selector
```