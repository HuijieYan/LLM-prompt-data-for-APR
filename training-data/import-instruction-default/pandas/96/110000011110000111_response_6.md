The issue arises in the apply function. The failing test_date_range_with_custom_holidays test shows that there is a problem with the application of CustomBusinessHour to a datetime range. The error message indicates a problem with the frequency validation.

The bug in the apply function seems to stem from the handling of holidays and the application of business hours, which results in an incorrect frequency validation and leads to the failure of the test.

The GitHub issue also points out the specific problem with date_range producing more periods than expected when using holidays and periods together.

To fix the bug, we need to revise the logic in the apply function related to the handling of holidays and frequency validation.

Here is a corrected version of the apply function:

```python
@apply_wraps
def apply(self, other):
    if isinstance(other, datetime):
        # rest of the code remains the same, only the holiday handling part is updated
        # ...

        if self.holidays is not None and other in self.holidays:
            raise ApplyTypeError("Datetime falls on holiday")

        return other
    else:
        raise ApplyTypeError("Only know how to combine business hour with datetime")
```

This modified version ensures that when the datetime falls on a holiday, an error is raised. This should resolve the issue with the incorrect frequency validation and the failing test.

This corrected code should now pass the failing test and resolve the issue posted in the GitHub thread.