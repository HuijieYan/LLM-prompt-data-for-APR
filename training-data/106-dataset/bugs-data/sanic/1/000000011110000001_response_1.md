The bug occurs in the `register_named_middleware` function. Looking at the error message, it seems that the response middleware is getting appended in reverse order. This indicates that the logic for appending middleware to response routes is incorrect.

The bug occurs because the logic for appending middleware to response routes is incorrect. Instead of appending middleware in the reverse order, it should be appended in the same order as in the request routes.

To fix the bug, we can combine the code for appending middleware to request and response routes. We can also simplify the logic by creating a dictionary to store both the request and response middleware, with the route names as keys.

Here's the corrected code for the `register_named_middleware` function:

```python
def register_named_middleware(self, middleware, route_names, attach_to="request"):
    if attach_to == "request":
        for _rn in route_names:
            if _rn not in self.named_middleware:
                self.named_middleware[_rn] = {"request": deque(), "response": deque()}
            if middleware not in self.named_middleware[_rn]["request"]:
                self.named_middleware[_rn]["request"].append(middleware)
    if attach_to == "response":
        for _rn in route_names:
            if _rn not in self.named_middleware:
                self.named_middleware[_rn] = {"request": deque(), "response": deque()}
            if middleware not in self.named_middleware[_rn]["response"]:
                self.named_middleware[_rn]["response"].append(middleware)
```