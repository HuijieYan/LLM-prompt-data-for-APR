# Test code

```json
[
    "    def test_rnn_additional_states(self):\n        # implement a simple RNN with an additional state\n        # whose shape is different from that of the output\n        num_samples = 4\n        input_dim = 5\n        output_dim = 3\n        timesteps = 6\n\n        _, x = parse_shape_or_val((num_samples, timesteps, input_dim))\n        _, h0 = parse_shape_or_val((num_samples, output_dim))\n        _, wi = parse_shape_or_val((input_dim, output_dim))\n        _, wh = parse_shape_or_val((output_dim, output_dim))\n        mask = np.random.randint(2, size=(num_samples, timesteps))\n\n        x_k = K.variable(x)\n        h0_k = [K.variable(h0), K.variable(np.concatenate([h0, h0], axis=-1))]\n        wi_k = K.variable(wi)\n        wh_k = K.variable(wh)\n        mask_k = K.variable(mask)\n\n        def rnn_fn(x_k, h_k):\n            assert len(h_k) == 2\n            y_k = K.dot(x_k, wi_k) + K.dot(h_k[0], wh_k)\n            return y_k, [y_k, K.concatenate([y_k, y_k], axis=-1)]\n\n        # test default setup\n        last_output_list = []\n        outputs_list = []\n        state_list = []\n\n        kwargs_list = [\n            {'go_backwards': False, 'mask': None},\n            {'go_backwards': False, 'mask': None, 'unroll': True, 'input_length': timesteps},\n            {'go_backwards': True, 'mask': None},\n            {'go_backwards': True, 'mask': None, 'unroll': True, 'input_length': timesteps},\n            {'go_backwards': False, 'mask': mask_k},\n            {'go_backwards': False, 'mask': mask_k, 'unroll': True, 'input_length': timesteps},\n        ]\n\n        for (i, kwargs) in enumerate(kwargs_list):\n            last_y1, y1, h1 = reference_operations.rnn(x, [wi, wh, None], h0, **kwargs)\n            last_y2, y2, h2 = K.rnn(rnn_fn, x_k, h0_k, **kwargs)\n\n            assert len(h2) == 2\n            last_y2 = K.eval(last_y2)\n            y2 = K.eval(y2)\n            h11 = h1[:, -1]\n            h12 = np.concatenate([h1[:, -1], h1[:, -1]], axis=-1)\n            h21 = K.eval(h2[0])\n            h22 = K.eval(h2[1])\n\n            if kwargs['mask'] is not None:\n                last_y1 = last_y1 * np.expand_dims(mask[:, -1], -1)\n                last_y2 = last_y2 * np.expand_dims(mask[:, -1], -1)\n                y1 = y1 * np.expand_dims(mask, -1)\n                y2 = y2 * np.expand_dims(mask, -1)\n                h11 = h11 * np.expand_dims(mask[:, -1], -1)\n                h21 = h21 * np.expand_dims(mask[:, -1], -1)\n                h12 = h12 * np.expand_dims(mask[:, -1], -1)\n                h22 = h22 * np.expand_dims(mask[:, -1], -1)\n\n            last_output_list.append(last_y2)\n            outputs_list.append(y2)\n            state_list.append((h21, h22))\n\n            if i % 2 == 0:\n                assert_allclose(last_y1, last_y2, atol=1e-05)\n                assert_allclose(y1, y2, atol=1e-05)\n                assert_allclose(h11, h21, atol=1e-05)\n                assert_allclose(h12, h22, atol=1e-05)\n            else:\n                assert_allclose(last_output_list[i - 1], last_output_list[i], atol=1e-05)\n                assert_allclose(outputs_list[i - 1], outputs_list[i], atol=1e-05)\n                assert_allclose(state_list[i - 1][0], state_list[i][0], atol=1e-05)\n                assert_allclose(state_list[i - 1][1], state_list[i][1], atol=1e-05)"
]
```
