The bug in the `CustomBusinessHour` class is causing the issue reported on GitHub. The issue arises from an inaccurate calculation within the `apply` method of the `BusinessHourMixin` class, which is used by the `CustomBusinessHour` class. The `apply` method includes business hours on holidays, which should be excluded. This causes the `date_range` function to produce more periods than expected when holidays are added.

To fix the bug, we need to modify the `apply` method to exclude business hours on holidays. We can achieve this by checking whether a given date is a holiday and skipping it when adjusting the date. We also need to ensure that business hours on holidays are not counted in the total business hours calculation.

Here's the corrected version of the `apply` method:

```python
# import necessary libraries for holiday handling
from pandas.tseries.holiday import AbstractHolidayCalendar, Holiday, USMemorialDay
from pandas.tseries.offsets import CustomBusinessHour

# Define a custom holiday calendar
class CustomBusinessHolidays(AbstractHolidayCalendar):
    rules = [
        # Define your holiday rules here
        # For example:
        # Holiday('New Year', month=1, day=1),
        # Holiday('Independence Day', month=7, day=4)
    ]

# Use the custom holiday calendar in your date_range function
holidays = CustomBusinessHolidays()

class CustomBusinessHourWithHolidays(CustomBusinessHour):
    def __init__(self, start='09:00', end='17:00', offset=1, name=None, holidays=None):
        # Call __init__ of the superclass
        super().__init__(start, end, offset, name)
        # Set holidays attribute
        self.holidays = holidays

    @apply_wraps
    def apply(self, other):
        if isinstance(other, datetime):
            # check if the date is a holiday
            if self.holidays and other in self.holidays.holidays():
                raise ApplyTypeError("Date falls on a holiday")

            # the rest of the method remains the same
            # ...

        else:
            raise ApplyTypeError("Only know how to combine business hour with datetime")
```

In this corrected version, we introduced a custom holiday calendar and a `CustomBusinessHourWithHolidays` class that extends the `CustomBusinessHour` class. The `apply` method checks if the date is a holiday and raises an error, excluding holidays from business hour calculations.

This should fix the issue reported on GitHub.