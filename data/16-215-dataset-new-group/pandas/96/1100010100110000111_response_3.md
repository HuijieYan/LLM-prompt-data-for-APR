The bug in the `apply` function is causing an issue with the `pd.date_range` function when adding holidays and using periods in the `CustomBusinessHour` offset.

The main issue seems to stem from the fact that the `apply` function does not correctly handle holidays while calculating the date range for CustomBusinessHour when using periods.

The issue can be fixed by adjusting the logic in the `apply` function to correctly handle holidays and periods while calculating the date range.

Here's a corrected version of the `apply` function:

```python
from pandas.tseries.offsets import CustomBusinessHour
from datetime import datetime, timedelta

def apply(self, other):
    if isinstance(other, datetime):
        if self.holidays and other.date() in self.holidays:
            raise ValueError(f"{other.date()} is a holiday")
        nanosecond = getattr(other, "nanosecond", 0)
        other = datetime(
            other.year,
            other.month,
            other.day,
            other.hour,
            other.minute,
            other.second,
            other.microsecond,
        )
        n = self.n

        businesshours = sum(
            self._get_business_hours_by_sec(st, en)
            for st, en in zip(self.start, self.end)
        )

        bd, r = divmod(abs(n * 60), businesshours // 60)
        if n < 0:
            bd, r = -bd, -r

        if bd != 0:
            skip_bd = CustomBusinessHour(n=bd, holidays=self.holidays)
            other = other + skip_bd

        business_minutes = 60 / (businesshours // len(self.start)) # minutes in each business hour

        while r > 0:
            if n >= 0:
                business_hour_end = datetime(
                    other.year, 
                    other.month, 
                    other.day, 
                    self.end[0].hour, 
                    self.end[0].minute
                )
                minutes_to_end = (business_hour_end - other).seconds/60
                if r >= business_minutes:
                    other = business_hour_end
                    r -= minutes_to_end
                else:
                    other = other + timedelta(minutes=r)
                    r = 0
            else:
                business_hour_start = datetime(
                    other.year, 
                    other.month, 
                    other.day, 
                    self.start[-1].hour, 
                    self.start[-1].minute
                )
                minutes_to_start = (other - business_hour_start).seconds/60
                if r >= minutes_to_start: # move to next business hour
                    other = self.start[-1]
                    r -= minutes_to_start
                else: # minutes remaining in current business hour
                    other = other - timedelta(minutes=r)
                    r = 0
        return other
    else:
        raise ApplyTypeError("Only know how to combine business hour with datetime")
```

This corrected `apply` function should now correctly handle periods and holidays when calculating the date range for CustomBusinessHour. After applying this fix, the failing test in the GitHub issue should pass successfully.