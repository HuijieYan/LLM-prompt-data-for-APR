This `test_comment_indentation` test fails due to a bug in the `_partially_consume_prefix` function. The function is intended to consume a prefix of text up to a certain indentation level, but it fails to handle comments correctly, leading to incorrect output and causing the test to fail.

The issue arises because the function does not properly handle comments when consuming the prefix. As a result, it fails to correctly consume the comment lines, leading to a mismatch with the expected output.

To fix the bug, we need to adjust the logic in the `_partially_consume_prefix` function to properly handle comments and their indentation level.

Here's the corrected version of the function:

```python
def _partially_consume_prefix(self, prefix, column):
    lines = []
    current_line = ""
    current_column = 0
    wait_for_nl = False
    for char in prefix:
        current_line += char
        if wait_for_nl:
            if char == '\n':
                if current_line.strip() and current_column < column:
                    res = ''.join(lines)
                    return res, prefix[len(res):]

                lines.append(current_line)
                current_line = ""
                current_column = 0
                wait_for_nl = False
        elif char == ' ':
            current_column += 1
        elif char == '\t':
            current_column += 4
        elif char == '\n':
            # unexpected empty line
            current_column = 0
            wait_for_nl = False  # Reset wait_for_nl on new line
        else:
            # indent is finished
            if current_line.strip().startswith("#"):  # Handle comment lines
                lines.append(current_line)
                current_line = ""
            else:
                wait_for_nl = True
    return ''.join(lines), current_line
```

This corrected version handles comment lines separately to ensure that their indentation levels are properly consumed. This should fix the bug and make the function behave as expected, passing the failing test.